#!/usr/bin/env ruby
require 'sinatra/base'
require 'bio-publisci'
require 'rack-flash'
require 'cgi'
require "sinatra/reloader"
require "sinatra/linkeddata"

class PubliSciServer < Sinatra::Base
  enable :sessions

  set :views, File.dirname(__FILE__) + '/../server/views'
  set :repository, RDF::Repository.new
  settings.repository.load(File.dirname(__FILE__) + '/../resources/primer.ttl')
  set :sudo_pass, nil

  use Rack::Flash

  require_relative '../server/helpers.rb'

  get "/" do
    redirect 'repository'
  end

  get "/query" do
    @repo = settings.repository
    @query = params[:query] || example_query()
    unless @repo
      flash[:notice] = "Need to Load a repository first!"

      redirect 'repository'
    end
    haml :query
  end

  post "/query" do
    @repo = settings.repository

    unless @repo
      flash[:notice] = "Need to Load a repository first!"

      redirect 'repository'
    end

    @query = params[:query]
    @result = content_for(query_repository(params[:query]))
    # @result =" asdfasdfas"

    content_response :query, @result
  end

  get "/repository" do
    redirect 'repository/new' unless settings.repository
    @repo = settings.repository

    content_response :repository, @repo
  end

  get "/repository/new" do
    @repo = settings.repository

    haml :new_repository
  end

  post "/repository/new" do
    type = params[:repo_type]
    settings.sudo_pass = params[:sudo_pass] if params[:sudo_pass]
    uri = params[:repo_uri] if params[:repo_uri]

    @repo = create_repository(type,uri)
    settings.repository = @repo

    redirect '/repository'
  end

  get "/repository/import" do
    @repo = settings.repository
    redirect '/repository' unless @repo

    haml :import
  end

  post "/repository/import" do
    @repo = settings.repository
    redirect '/repository' unless @repo

    if params[:upload_file]
      @result = import_rdf(params[:upload_file][:tempfile], :file)
    else
      @result = import_rdf(params[:rdf_string], params[:rdf_format])
    end
    flash.now[:notice] = @result
    content_response haml :import, content_for(@result)
  end

  post "/repository/export" do
    type = params[:repo_type]
    settings.sudo_pass = params[:sudo_pass] if params[:sudo_pass]
    uri = params[:repo_uri] if params[:repo_uri]

    @repo = create_repository(type,uri)

    haml :export
  end

  get "/repository/delete" do
    clear_repository

    redirect 'repository'
  end

  run! if app_file == $0
end