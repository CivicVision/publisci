#!/usr/bin/env ruby
require 'sinatra/base'
require 'bio-publisci'
require 'rack-flash'
require 'cgi'
require "sinatra/reloader"
require "sinatra/linkeddata"
require "sinatra/cross_origin"
require "sinatra/cross_origin"

class PubliSciServer < Sinatra::Base
  configure do
    enable :sessions
    enable :cross_origin
  end

  set :views, File.dirname(__FILE__) + '/../server/views'
  set :repository, RDF::FourStore::Repository.new('http://localhost:8080')
  # set :repository, RDF::Repository.new
  settings.repository.load(File.dirname(__FILE__) + '/../resources/primer.ttl')
  set :sudo_pass, nil

  use Rack::Flash

  require_relative '../server/helpers.rb'

  get "/" do
    redirect 'repository'
  end

  get "/query" do
    @repo = settings.repository
    @query = params[:query] || example_query()
    unless @repo
      flash[:notice] = "Need to Load a repository first!"

      redirect 'repository'
    end
    haml :query
  end

  post "/query" do
    @repo = settings.repository

    unless @repo
      flash[:notice] = "Need to Load a repository first!"

      redirect 'repository'
    end

    @query = params[:query]
    @result = content_for(query_repository(params[:query]))

    content_response :query, @result
  end

  get "/repository" do
    redirect 'repository/new' unless settings.repository
    @repo = settings.repository

    content_response :repository, @repo
  end

  get "/repository/new" do
    @repo = settings.repository

    haml :new_repository
  end

  post "/repository/new" do
    type = params[:repo_type]
    settings.sudo_pass = params[:sudo_pass] if params[:sudo_pass]
    uri = params[:repo_uri] if params[:repo_uri]

    @repo = create_repository(type,uri)
    settings.repository = @repo

    redirect '/repository'
  end

  get "/repository/import" do
    @repo = settings.repository
    redirect '/repository' unless @repo

    haml :import
  end

  post "/repository/import" do
    @repo = settings.repository
    redirect '/repository' unless @repo

    if params[:upload_file]
      type = File.extname(params[:upload_file][:filename])
      if type.size > 0
        type = type[1..-1].to_sym
      else
        raise "Unknown Type for file #{params[:upload_file][:filename]}"
      end
      @result = import_rdf(params[:upload_file][:tempfile], type)
    else
      @result = import_rdf(params[:rdf_string], params[:rdf_format])
    end
    flash.now[:notice] = @result
    content_response :import, content_for(@result)
  end

  get "/repository/dump" do
    @repo = settings.repository
    redirect '/repository' unless @repo

    content_response(:dump, @repo)
  end

  get "/repository/clear" do
    clear_repository

    redirect '/'
  end

  run! if app_file == $0
end